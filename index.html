<?php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $userMessage = $_POST['message'] ?? '';
    $apiKey = 'AIzaSyDxYqHU2fiBu9OvA8Hw9y3NlV1gcahrH-o'; // Ganti dengan API KEY kamu dari Google AI

    $postData = [
        'contents' => [
            [
                'parts' => [
                    ['text' => $userMessage]
                ]
            ]
        ]
    ];

    $ch = curl_init("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$apiKey");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($postData));

    $response = curl_exec($ch);
    $error = curl_error($ch);
    curl_close($ch);

    if ($error) {
        echo json_encode(['reply' => 'Error: ' . $error]);
    } else {
        $responseData = json_decode($response, true);
        $reply = $responseData['candidates'][0]['content']['parts'][0]['text'] ?? 'Tidak ada balasan.';
        echo json_encode(['reply' => $reply]);
    }
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Chat (Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-xl bg-white rounded-lg shadow-md p-4 flex flex-col h-[90vh]">
        <h1 class="text-2xl font-bold mb-4 text-center">AI Chat (Gemini)</h1>

        <div id="chat" class="flex-1 overflow-y-auto space-y-2 mb-4 p-2 border rounded bg-gray-50">
            <!-- Chat messages here -->
        </div>

        <form id="chat-form" class="flex space-x-2">
            <input id="user-input" name="message" type="text" placeholder="Tulis pesan..."
                class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button type="submit"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Kirim</button>
        </form>
    </div>

    <script>
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const chat = document.getElementById('chat');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const userMessage = input.value.trim();
            if (!userMessage) return;

            appendMessage('user', userMessage);
            input.value = '';

            appendMessage('assistant', 'Mengetik...');
            const loadingEl = chat.lastChild;

            try {
                const res = await fetch('', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        message: userMessage
                    })
                });
                const data = await res.json();
                loadingEl.remove();
                appendMessage('assistant', data.reply || '[Kosong]');
            } catch (err) {
                loadingEl.remove();
                appendMessage('assistant', 'Terjadi kesalahan saat menghubungi API.');
            }
        });

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `p-2 rounded whitespace-pre-wrap ${
                role === 'user' ? 'bg-blue-100 self-end text-right' : 'bg-gray-200 self-start text-left'
            }`;
            if (role === 'assistant') {
                div.innerHTML = formatTextToHTML(text);
            } else {
                div.textContent = text;
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function formatTextToHTML(text) {
            const lines = text.split('\n');
            let html = '';
            let inOl = false;
            let inUl = false;

            for (let line of lines) {
                line = line.trim();

                // Ordered list
                if (/^\d+\./.test(line)) {
                    if (!inOl) {
                        html += '<ol class="list-decimal ml-5">';
                        inOl = true;
                    }
                    html += `<li>${line.replace(/^\d+\.\s*/, '')}</li>`;
                }
                // Unordered list
                else if (/^[-*]\s+/.test(line)) {
                    if (!inUl) {
                        html += '<ul class="list-disc ml-5">';
                        inUl = true;
                    }
                    html += `<li>${line.replace(/^[-*]\s+/, '')}</li>`;
                }
                // Paragraph
                else {
                    if (inOl) {
                        html += '</ol>';
                        inOl = false;
                    }
                    if (inUl) {
                        html += '</ul>';
                        inUl = false;
                    }
                    if (line) {
                        html += `<p class="mb-2">${line}</p>`;
                    }
                }
            }

            if (inOl) html += '</ol>';
            if (inUl) html += '</ul>';
            return html;
        }
    </script>
</body>

</html>