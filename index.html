<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kelompok AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col md:flex-row">

  <!-- Sidebar Riwayat -->
  <aside class="md:w-1/4 w-full bg-white border-b md:border-r md:border-b-0 p-4 overflow-y-auto" id="history">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold text-blue-600">Riwayat</h2>
      <button onclick="startNewSession()" class="text-sm bg-green-500 px-2 py-2 rounded-md text-white hover:bg-green-600">Mulai Chat Baru</button>
    </div>
    <ul id="historyList" class="space-y-2 text-sm"></ul>
  </aside>

  <!-- Area Chat -->
  <main class="flex flex-col w-full h-full items-center justify-center">
    <div class="w-full bg-white rounded shadow p-4 space-y-4 flex flex-col h-[100vh]">
      <h1 class="text-xl font-bold text-blue-700 text-center">Selamat Datang</h1>
      <div id="chat" class="flex-1 overflow-y-auto p-2 border rounded bg-gray-50 space-y-4 text-sm"></div>
      <form id="form" class="flex space-x-2">
        <input id="message" class="flex-1 border p-2 rounded" placeholder="Tulis pertanyaan..." />
        <button class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700" type="submit">Kirim</button>
      </form>
    </div>
  </main>

  <script>
    const form = document.getElementById('form');
    const input = document.getElementById('message');
    const chat = document.getElementById('chat');
    const historyList = document.getElementById('historyList');
    const API_KEY = 'AIzaSyDcg3R3kVaWp0QHuUOug49aUSXfpzuXQ_A';

    let sessions = JSON.parse(localStorage.getItem('gemini_sessions')) || [];
    let currentSessionIndex = sessions.length - 1;

    if (currentSessionIndex < 0) {
      sessions.push([]);
      currentSessionIndex = 0;
    }

    renderSession(currentSessionIndex);
    renderHistory();

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      append('🧑‍💻 Kamu', text);
      append('🤖 Gemini', 'Mengetik...');
      input.value = '';

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `${text}\n\nTolong berikan jawaban berbentuk paragraf rapi, sertakan link jurnal atau artikel ilmiah (DOI jika ada), dan jika menjelaskan dalam poin gunakan format 1., 2., dst tanpa tanda bintang, dan beri <b>teks tebal</b> pada kata kunci.`
              }]
            }]
          })
        });

        const json = await response.json();
        chat.lastChild.remove();

        let reply = json?.candidates?.[0]?.content?.parts?.[0]?.text ?? '[Tidak ada balasan]';
        reply = formatReply(reply);
        append('🤖 Gemini', reply);

        // Simpan ke sesi
        sessions[currentSessionIndex].push({ question: text, answer: reply });
        localStorage.setItem('gemini_sessions', JSON.stringify(sessions));
        renderHistory();
      } catch (err) {
        chat.lastChild.remove();
        append('🤖 Gemini', 'Gagal menghubungi API.');
      }
    });

    function append(name, msg) {
      const div = document.createElement('div');
      div.className = 'p-2 border-b';
      div.innerHTML = `<strong>${name}:</strong><br>${msg}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function formatReply(text) {
      text = text
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 underline">$1</a>')
        .replace(/^\d+\.\s\*\*(.*?)\*\*/gm, (_, word) => `1. <b>${word}</b>`) // if still use ** inside point
        .replace(/^\d+\.\s(.*?)(?=\n|$)/gm, (match, p1) => match.replace(p1, `<b>${p1}</b>`));

      const lines = text.split('\n').map(line => {
        if (/^\d+\.\s/.test(line)) {
          return `<div class="ml-4">${line}</div>`;
        } else if (line.trim() === '') {
          return '<br>';
        } else {
          return `<p class="text-justify">${line}</p>`;
        }
      });

      return lines.join('');
    }

    function renderSession(index) {
      chat.innerHTML = '';
      sessions[index].forEach(({ question, answer }) => {
        append('🧑‍💻 Kamu', question);
        append('🤖 Gemini', answer);
      });
    }

    function renderHistory() {
      historyList.innerHTML = '';
      sessions.forEach((session, i) => {
        const firstQ = session[0]?.question?.slice(0, 30) || 'Chat Kosong';
        const li = document.createElement('li');
        li.innerHTML = `<button onclick="switchSession(${i})" class="text-left text-blue-600 hover:underline w-full">${i + 1}. ${firstQ}</button>`;
        historyList.appendChild(li);
      });
    }

    window.switchSession = function (index) {
      currentSessionIndex = index;
      renderSession(index);
    };

    function startNewSession() {
      sessions.push([]);
      currentSessionIndex = sessions.length - 1;
      localStorage.setItem('gemini_sessions', JSON.stringify(sessions));
      renderHistory();
      renderSession(currentSessionIndex);
    }
  </script>
</body>
</html>
